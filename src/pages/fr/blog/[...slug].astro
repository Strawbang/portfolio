---
import { type CollectionEntry, getCollection } from 'astro:content';
import FrenchBaseLayout from '../../../layouts/FrenchBaseLayout.astro';
import ContactCTA from '../../../components/ContactCTA.astro';
import { calculateReadingTime, getReadingTimeText } from '../../../utils/readingTime';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts
    .filter(post => !post.data.draft)
    .map((post) => ({
      params: { slug: post.slug },
      props: post,
    }));
}

type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content } = await post.render();
const readingTime = calculateReadingTime(post.body);
const readingTimeText = getReadingTimeText(readingTime, 'fr');

const formattedDate = post.data.publishDate.toLocaleDateString('fr-FR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const formattedUpdatedDate = post.data.updatedDate?.toLocaleDateString('fr-FR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<FrenchBaseLayout
  title={`${post.data.title} | Blog`}
  description={post.data.description}
  canonicalURL={post.data.canonicalURL}
  image={post.data.img}
  type="article"
  publishedTime={post.data.publishDate.toISOString()}
  tags={post.data.tags}
>
  <div class="wrapper stack gap-10 lg:gap-20">
    <header class="hero stack gap-4">
      <div class="stack gap-2">
        <a href="/fr/blog" class="back-link">← Retour au blog</a>
        <h1 class="title">{post.data.title}</h1>
      </div>
      
      <div class="meta">
        <time datetime={post.data.publishDate.toISOString()}>
          Publié le {formattedDate}
        </time>
        <span class="reading-time">• {readingTimeText}</span>
        {post.data.updatedDate && (
          <time datetime={post.data.updatedDate.toISOString()}>
            • Mis à jour le {formattedUpdatedDate}
          </time>
        )}
      </div>

      {post.data.canonicalURL && (
        <div class="canonical-notice">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          Cet article est également publié sur <a href={post.data.canonicalURL} target="_blank" rel="noopener noreferrer">une autre plateforme</a>.
        </div>
      )}

      <div class="tags">
        {post.data.tags.map((tag) => (
          <span class="tag">{tag}</span>
        ))}
      </div>

      {post.data.img && (
        <img 
          src={post.data.img} 
          alt={post.data.img_alt || post.data.title}
          class="hero-image"
        />
      )}
    </header>

    <article class="content">
      <Content />
    </article>

    <ContactCTA />
  </div>
</FrenchBaseLayout>

<style>
  .wrapper {
    padding-block: 2rem;
  }

  .hero {
    padding-block: 2rem;
  }

  .back-link {
    color: var(--accent-regular);
    text-decoration: none;
    font-size: var(--text-md);
    transition: color 0.2s ease;
  }

  .back-link:hover {
    color: var(--accent-dark);
  }

  .title {
    font-size: var(--text-4xl);
    color: var(--gray-0);
    line-height: 1.2;
  }

  .meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    color: var(--gray-400);
    font-size: var(--text-md);
  }

  .canonical-notice {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background-color: var(--accent-dark);
    border-left: 4px solid var(--accent-regular);
    border-radius: 0.5rem;
    color: var(--gray-200);
    font-size: var(--text-sm);
  }

  .canonical-notice svg {
    flex-shrink: 0;
    color: var(--accent-regular);
  }

  .canonical-notice a {
    color: var(--accent-regular);
    text-decoration: underline;
  }

  .canonical-notice a:hover {
    color: var(--accent-light);
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag {
    background-color: var(--gray-800);
    color: var(--gray-300);
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: var(--text-sm);
  }

  .hero-image {
    width: 100%;
    max-height: 500px;
    object-fit: cover;
    border-radius: 1rem;
    box-shadow: var(--shadow-lg);
  }

  .content {
    max-width: 65ch;
    margin-inline: auto;
    font-size: var(--text-lg);
    line-height: 1.8;
    color: var(--gray-300);
  }

  .content :global(h1),
  .content :global(h2),
  .content :global(h3),
  .content :global(h4),
  .content :global(h5),
  .content :global(h6) {
    color: var(--gray-0);
    margin-top: 2rem;
    margin-bottom: 1rem;
    line-height: 1.3;
  }

  .content :global(h1) {
    font-size: var(--text-3xl);
  }

  .content :global(h2) {
    font-size: var(--text-2xl);
  }

  .content :global(h3) {
    font-size: var(--text-xl);
  }

  .content :global(p) {
    margin-bottom: 1.5rem;
  }

  .content :global(a) {
    color: var(--accent-regular);
    text-decoration: underline;
  }

  .content :global(a:hover) {
    color: var(--accent-dark);
  }

  .content :global(ul),
  .content :global(ol) {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
  }

  .content :global(li) {
    margin-bottom: 0.5rem;
  }

  .content :global(code) {
    background-color: var(--gray-800);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.9em;
    font-family: 'Courier New', monospace;
  }

  .content :global(pre) {
    background-color: var(--gray-999);
    padding: 1.5rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-bottom: 1.5rem;
    border: 1px solid var(--gray-800);
  }

  .content :global(pre code) {
    background-color: transparent;
    padding: 0;
  }

  .content :global(blockquote) {
    border-left: 4px solid var(--accent-regular);
    padding-left: 1.5rem;
    margin: 2rem 0;
    font-style: italic;
    color: var(--gray-400);
  }

  .content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 0.5rem;
    margin: 2rem 0;
  }

  .content :global(hr) {
    border: none;
    border-top: 1px solid var(--gray-800);
    margin: 3rem 0;
  }

  @media (min-width: 50em) {
    .wrapper {
      padding-block: 4rem;
    }

    .title {
      font-size: var(--text-5xl);
    }
  }
</style>
